WITH species_with_same_binomial_as_birdlife AS (
    SELECT
        scientific_name,
        ebird_taxonomy.common_name,
        scientific_name AS birdlife_scientific_name,
        birdlife.common_name AS birdlife_common_name
    FROM {{ ref('used_taxonomy_all') }} ebird_taxonomy
        JOIN {{ ref('birdlife_taxonomy_with_alternatives') }} birdlife USING (scientific_name)
), species_with_alternative_binomial_in_birdlife AS (
    SELECT
        ebird_taxonomy.scientific_name,
        ebird_taxonomy.common_name,
        birdlife.scientific_name AS birdlife_scientific_name,
        birdlife.common_name AS birdlife_common_name
    FROM {{ ref('birdlife_taxonomy_with_alternatives') }} birdlife
        JOIN UNNEST(birdlife.alternative_scientific_names) alternative_scientific_name
        JOIN {{ ref('used_taxonomy_all') }} ebird_taxonomy ON ebird_taxonomy.scientific_name = alternative_scientific_name
), manually_mapped_species AS (
    SELECT
        ebird_taxonomy.scientific_name AS scientific_name,
        ebird_taxonomy.common_name AS common_name,
        birdlife.scientific_name AS birdlife_scientific_name,
        birdlife.common_name AS birdlife_common_name
    FROM {{ ref('used_taxonomy_all') }} ebird_taxonomy
        JOIN {{ source('dropbox', 'avibase_manually_mapped_taxonomy') }} manual_mapping
            ON ebird_taxonomy.scientific_name = manual_mapping.ebird_scientific_name
        JOIN {{ ref('birdlife_taxonomy_with_alternatives') }} birdlife
            ON birdlife.scientific_name = manual_mapping.alternative_scientific_name
), mapped_taxonomy AS (
    SELECT * FROM species_with_same_binomial_as_birdlife
    UNION ALL
    SELECT * FROM species_with_alternative_binomial_in_birdlife
    UNION ALL
    SELECT * FROM manually_mapped_species
), dedupped AS (
    SELECT
        mapped_taxonomy.scientific_name AS scientific_name,
        mapped_taxonomy.common_name AS common_name,
        birdlife.iucn_red_list_2020,
        row_number() OVER (PARTITION BY mapped_taxonomy.scientific_name ORDER BY iucn_red_list_order ASC) AS rownum
    FROM mapped_taxonomy
    JOIN {{ ref('base_birdlife_taxonomy') }} birdlife ON birdlife.scientific_name = birdlife_scientific_name
)
SELECT
    * EXCEPT (rownum)
FROM dedupped
WHERE rownum = 1
